# HG changeset patch
# Parent 0603e401d941cbfaa6dea050149bb5309ff4b5a0
Bug 590411 - Sync/Weave is not included if FF is built against libxul sdk

diff --git a/browser/build.mk b/browser/build.mk
--- a/browser/build.mk
+++ b/browser/build.mk
@@ -40,16 +40,21 @@ include $(topsrcdir)/toolkit/toolkit-tie
 endif
 
 TIERS += app
 
 ifdef MOZ_EXTENSIONS
 tier_app_dirs += extensions
 endif
 
+ifdef MOZ_SERVICES_SYNC
+tier_app_dirs += services/crypto
+tier_app_dirs += services/sync
+endif
+
 tier_app_dirs += $(MOZ_BRANDING_DIRECTORY)
 
 tier_app_dirs += browser
 
 installer:
 	@$(MAKE) -C browser/installer installer
 
 package:
diff --git a/services/sync/Weave.js b/services/sync/Weave.js
--- a/services/sync/Weave.js
+++ b/services/sync/Weave.js
@@ -76,17 +76,17 @@ WeaveService.prototype = {
                     .getService(Ci.nsIIOService);
     let resProt = ioService.getProtocolHandler("resource")
                   .QueryInterface(Ci.nsIResProtocolHandler);
 
     // Only create alias if resource://services-sync doesn't already exist.
     if (resProt.hasSubstitution("services-sync"))
       return;
 
-    let uri = ioService.newURI("resource://gre/modules/services-sync/",
+    let uri = ioService.newURI("resource:///modules/services-sync/",
                                null, null);
     resProt.setSubstitution("services-sync", uri);
   }
 };
 
 function AboutWeaveLog() {}
 AboutWeaveLog.prototype = {
   classID: Components.ID("{d28f8a0b-95da-48f4-b712-caf37097be41}"),
diff --git a/toolkit/toolkit-tiers.mk b/toolkit/toolkit-tiers.mk
--- a/toolkit/toolkit-tiers.mk
+++ b/toolkit/toolkit-tiers.mk
@@ -266,19 +266,14 @@ endif
 ifdef MOZ_LEAKY
 tier_platform_dirs        += tools/leaky
 endif
 
 ifdef MOZ_MAPINFO
 tier_platform_dirs	+= tools/codesighs
 endif
 
-ifdef MOZ_SERVICES_SYNC
-tier_platform_dirs += services/crypto
-tier_platform_dirs += services/sync
-endif
-
 ifdef ENABLE_TESTS
 tier_platform_dirs += testing/mochitest
 tier_platform_dirs += testing/xpcshell 
 tier_platform_dirs += testing/mozmill
 endif
 
